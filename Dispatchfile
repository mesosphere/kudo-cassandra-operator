#!mesosphere/dispatch-starlark:v0.5

load("github.com/mesosphere/dispatch-catalog/starlark/stable/pipeline@0.0.4", "gitResource")

gitResource("kudo-cassandra-operator", url="$(context.git.url)", revision="$(context.git.commit)")

load("github.com/mesosphere/dispatch-catalog/starlark/stable/docker@0.0.4", "dindTask")
load("github.com/mesosphere/dispatch-catalog/starlark/stable/pipeline@0.0.4", "storageResource")

storageResource("artifacts")

dindTask("checks", inputs=["kudo-cassandra-operator"], outputs=["artifacts"], steps=[k8s.corev1.Container(
  name="dind",
  image="mesoporridge/dispatch-dind:0.0.13",
  command=[
    "/entrypoint.sh",
    "bash", "-c",
    "set -xe; if ! kind -v 9 create cluster --retain --image mesoporridge/kindest-node:0.0.7; then docker ps -a; id=$(docker ps -l --format '{{.ID}}');docker logs $id; kind export logs $(resources.outputs.artifacts.path); exit 1;fi"
  ],
  workingDir="/workspace",
  resources=k8s.corev1.ResourceRequirements(
    limits={
      "cpu": k8s.resource_quantity("2000m"),
      "memory": k8s.resource_quantity("7.5Gi")
    },
    requests={
      "cpu": k8s.resource_quantity("2000m"),
      "memory": k8s.resource_quantity("7.5Gi")
    }
  )
)
])

load("github.com/mesosphere/dispatch-catalog/starlark/stable/pipeline@0.0.4", "push")
action(tasks=["checks"], on=push())
