# Benchmarks

## Running a benchmark session

### Set up some KUDO Cassandra instance information

```bash
kudo_cassandra_operator_name="cassandra"
kudo_cassandra_operator_version="0.2.0"
kudo_cassandra_instance_name="cassandra"
kudo_cassandra_instance_namespace="cassandra"
kudo_cassandra_statefulset_name="node"

svc_endpoint="${kudo_cassandra_instance_name}-svc.${kudo_cassandra_instance_namespace}.svc.cluster.local"
```

### Create namespace

```bash
kubectl create namespace "${kudo_cassandra_instance_namespace}"
```

### Install KUDO Cassandra with some parameters

Tweak the parameters as desired.

```bash
kubectl kudo install ./operator \
        --instance="${kudo_cassandra_instance_name}" \
        --namespace="${kudo_cassandra_instance_namespace}" \
        -p "NODE_COUNT=10" \
        -p "NODE_MEM_MIB=8196" \
        -p "NODE_MEM_LIMIT_MIB=8196" \
        -p "NODE_CPU_MC=6000" \
        -p "NODE_CPU_LIMIT_MC=6000" \
        -p "NODE_DISK_SIZE_GIB=100" \
        -p "PROMETHEUS_EXPORTER_CPU_MC=1000" \
        -p "PROMETHEUS_EXPORTER_CPU_LIMIT_MC=1000"
```

### Wait for deploy plan to be `COMPLETE`

```bash
kubectl kudo plan status \
        --instance="${kudo_cassandra_instance_name}" \
        --namespace="${kudo_cassandra_instance_namespace}"
```

### Make sure `nodetool status` looks good

```bash
pod="0"
container="cassandra"
kubectl exec "pod/${kudo_cassandra_instance_name}-${kudo_cassandra_statefulset_name}-${pod}" \
        -n "${kudo_cassandra_instance_namespace}" \
        -c "${container}" \
        -- \
        bash -c "\
          nodetool status
        "
```

### Run `kassandra-stress`

This will create a Kubernetes deployment resource. Tweak the parameters as
desired.

```bash
workload_name="cassandra-workload-1"
```

```bash
./benchmarks/kassandra-stress \
  --kubernetes-namespace "${kudo_cassandra_instance_namespace}" \
  --workload-name "${workload_name}" \
  --hosts "${svc_endpoint}" \
  --number-of-clients 20 \
  --keyspace-name "cassandra_stress" \
  --one-keyspace-per-client false \
  --duration "1h"
```

### Generate workload by applying the deployment generated by `kassandra-stress`

```bash
kubectl apply -f benchmarks/kassandra_stress_replica_set.yaml
```

### Check workload deployment

```bash
kubectl get deployment -n "${kudo_cassandra_instance_namespace}"
```

### Check workload pods

```bash
kubectl get deployment -n "${kudo_cassandra_instance_namespace}"
```

### Delete workload

```bash
kubectl delete <deployment> -n "${kudo_cassandra_instance_namespace}"
```

### Uninstall operator

```bash
./scripts/uninstall_operator.sh \
  --operator "${kudo_cassandra_operator_name}" \
  --version "${kudo_cassandra_operator_version}" \
  --instance "${kudo_cassandra_instance_name}" \
```
